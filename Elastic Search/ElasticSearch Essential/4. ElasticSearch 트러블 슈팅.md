# ElasticSearch 트러블 슈팅

## 트러블 슈팅 기본
+ 트러블 슈팅이란 ? : 문제 상황을 파악하고 원인을 분석 후 해결하는 과정

## 문제 상황 파악
1. 모니터링 알람 확인
2. 클러스터 상태 확인
3. 노드에서의 에러 로그 확인
4. 클라이언트에서의 에러 로그 확인

## 원인 분석
+ 왜 문제가 발생 했는가?
1. 주요 지표 살펴보기
2. 에러 로그 분석

## 트러블 슈팅 사례 분석
+ 클러스터 상태가 green이 아니에요

> 이 자체가 문제인 상황으로 보면된다.

<img width="539" alt="image" src="https://user-images.githubusercontent.com/49984996/218288326-8cf8f4d5-559d-4dab-80a1-8c94a653616c.png">

+ Yellow 혹은 Red상태에 따른 영향도를 정확하게 파악하는 것이 먼저입니다.

## 원인 분석
```
curl -X GET "localhost:9200/_cat/indices" | grep -i red
```

+ Yellow 혹은 Red인 인덱스들 중 어떤 샤드들에 문제가 생겼는지 파악합니다.

## 트러블 슈팅 사례 분석 2
+ 클러스터에 갑자기 문서가 색인이 되지 않아요.
+ 클라이언트에서 403 Forbidden Error가 발생합니다.

## 원인 분석
+ 노드의 디스크 사용량이 100%가 되면 노드의 운영체제도 정상 동작하지 않습니다.
+ ElasticSearach에는 디스크 사용량이 일정 수준 이상이 되면 더이상 색인되지 않는 보호 장치가 있습니다.

<img width="772" alt="image" src="https://user-images.githubusercontent.com/49984996/219390533-a7f2bd6f-27c7-40ed-aa06-d8c0d116372c.png">

## 원인 해결
+ 데이터 노드를 증설하거나 불필요한 인덱스를 삭제해서 디스크 공간을 확보합니다.

## 트러블 슈팅 사례 분석 3

+ 간헐적으로 색인 과정에서 일부 문서가 누락되요.
  - 노드에서 간헐적으로 Rejected 에러가 발생 합니다.
+ ElasticSearch는 색인/검색 요청을 처리하는 스레드가 존재 합니다.
+ 그리고 스레드가 모두 요청을 처리하고 있을 때를 대비해서 큐도 존재합니다.
+ 하지만 모든 큐가 꽉 차 있다면? 이 때 Rejected가 발생합니다.

## 문제 해결
+ 데이터 노드 증설
+ 큐 증설

## 트러블 슈팅 사례 분석 4
+ 샤드 배치가 되지 않아요 - RED, YELLOW
  - Disk가 꽉차서 flood stage
  - 노드들이 가지고 있을 수 있는 전체 샤드의 개수에는 제한이 존재 합니다.
  - 그리고 이 제한을 넘어가면 더 이상 샤드가 생성되지 않고 인덱스 생성도 불가능합니다.

## 문제 해결
1. 데이터 노드 증설
2. 인덱스 설정 변경
3. cluster.max_shards_per_node 변경 (1000이 기본)

+ 3번에서 너무 많은 샤드가 배치되면 사이드 이펙트가 있으면 너무 크게 잡는거는 권고하지 않습니다.

