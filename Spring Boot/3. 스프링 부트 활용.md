# 스프링 부트 활용

## SpringApplication 1부
+ 기본 로그 레벨 INFO
  - 뒤에 로깅 수업때 자세히 살펴볼 예정
  - VM options, Program arguments에서 로그레벨 변경 가능
    - 어떠한 자동설정이 적용됬는지 볼수 있다.
+ FailureAnalyzer
  - 에러메시지를 이쁘게 출력
  - 사용할 일은 거의 없다.

+ 배너
  - src/main/resource
  - banner.txt | gif | jpg | png
  - ${spring-boot.version} 등의 변수를 사용할 수 있음.
  - classpath 또는 spring.banner.location으로 배너 위치 변경 가능
  - 자바 코드로 Banner 클래스 구현하고 SpringApplication.setBanner()로 설정 가능.
  - 배너 끄는 방법 setBanner(Banner.Mode.OFF);
  - 
+ SpringApplicationBuilder로 빌더 패턴 사용 가능
```java
new SpringApplicationBuilder()
  .sources(SpringinitApplication.class)
  .run(args);
```

## SpringApplication 2부

+ ApplicationEvent 등록
  - ApplicationEvent란? Application이 정상적으로 떳는지, 실패했는지 등등... 여러 이벤트가 있다.
  - ApplicationContext를 만들기 전에 사용하는 리스너는 @Bean으로 등록할 수 없다.
    - SpringApplication.addListners();
+ WebApplicationType 설정
  - 기본은 SERVLET, webflux는 reactive
+ 애플리케이션 아규먼트 사용하기
  - ApplicationArguments를 빈으로 등록해 주니까 가져다 쓰면 됨.
 
+ 애플리케이션 실행한 뒤 뭔가 실행하고 싶을 때
  - ApplicationRunner (추천) 또는 CommandLineRunner
  - 순서 지정 가능 @Order (숫자가 낮을 수록 우선 순위가 높다)

## 외부 설정 1부

+ 사용할 수 있는 외부 설정
  - properties (application.properties)
  - YAML
  - 환경 변수
  - 커맨드 라인 아규먼트

+ 프로퍼티 우선 순위
  - 유저 홈 디렉토리에 있는 spring-boot-dev-tools.properties
  - 테스트에 있는 @TestPropertySource
  - @SpringBootTest 애노테이션의 properties 애트리뷰트
  - 커맨드 라인 아규먼트
  - SPRING_APPLICATION_JSON (환경 변수 또는 시스템 프로티) 에 들어있는 프로퍼티
  - ServletConfig 파라미터
  - ServletContext 파라미터
  - java:comp/env JNDI 애트리뷰트
  - System.getProperties() 자바 시스템 프로퍼티
  - OS 환경 변수
  - RandomValuePropertySource
  - JAR 밖에 있는 특정 프로파일용 application properties
  - JAR 안에 있는 특정 프로파일용 application properties
  - JAR 밖에 있는 application properties
  - JAR 안에 있는 application properties
  - @PropertySource
  - 기본 프로퍼티 (SpringApplication.setDefaultProperties)

+ application.properties 우선 순위 (높은게 낮은걸 덮어 씁니다.)
  - file:./config/
  - file:./
  - classpath:/config/
  - classpath:/

+ 랜덤값 설정하기
  - ${random.*}

+ 플레이스 홀더
  - name = keesun
  - fullName = ${name} baik

## 외부 설정 2부

+ 타입-세이프 프로퍼티 @ConfigurationProperties
  - 프로퍼티에 설정된 정보를 자바코드로 읽어서 사용할 수 있다.
  - 여러 프로퍼티를 묶어서 읽어올 수 있음
  - 빈으로 등록해서 다른 빈에 주입할 수 있음
    - @EnableConfigurationProperties
    - @Component
    - @Bean
  - 융통성 있는 바인딩
    - context-path (케밥)
    - context_path (언드스코어)
    - contextPath (캐멀)
    - CONTEXTPATH
  - 프로퍼티 타입 컨버전
    - @DurationUnit
  - 프로퍼티 값 검증
    - @Validated
    - JSR-303 (@NotNull, ...)
  - 메타 정보 생성
  - @Value
    - SpEL 을 사용할 수 있지만...

## 프로파일

+ @Profile 애노테이션은 어디에?
  - @Configuration
  - @Component
  - 예 : @Profile("prod") : 빈 설정파일이 prod일때 적용 / @Profile("test")  : 빈 설정파일이 test일때
+ 어떤 프로파일을 활성화 할 것인가?
  - spring.profiles.active
    - spring.profiles.active=prod / spring.profiles.active=test
+ 어떤 프로파일을 추가할 것인가?
  - spring.profiles.include
    - 다른 프로파일도 include하여 활성화
+ 프로파일용 프로퍼티
  - application-{profile}.properties
    - 예) application-prod.properties
    - 예) application-test.properties

## 로깅 1부: 스프링 부트 기본 로거 설정

+ 로깅 퍼사드 VS 로거
  - 로깅 퍼사드: Commons Logging, SLF4j / 스프링 부트는 Commons Logging, SLF4j를 사용한다 - 실제 로깅을 하는 애들이 아닌 로깅 api를 추상화 해 놓은 인터페이스이다.  로깅 퍼사드의 장점 : 로깅 퍼사드는 다른 로거들로 바꿔 낄수 있다.
  - 로거: JUL, Log4J2, Logback : 처음 스프링부트 시작할때는 Logback이 로그를 남긴다.
+ 스프링 5에 로거 관련 변경 사항
  - https://docs.spring.io/spring/docs/5.0.0.RC3/spring-framework-reference/overview.html#overview-logging
  - Spring-JCL
    - Commons Logging -> SLF4j or Log4j2로 변경하는 모듈이다.
    - pom.xml에 exclusion 안해도 됨.
+ 스프링 부트 로깅
  - 기본 포맷 : 날짜 / 시간 / 로그 레벨 / pid / 쓰레드 이름 / 풀 패키지 경로 / 메시지 등등..
  - --debug (일부 핵심 라이브러리만 디버깅 모드로)
  - --trace (전부 다 디버깅 모드로)
  - 컬러 출력: spring.output.ansi.enabled
    - spring.output.ansi.enabled=always
  - 파일 출력: logging.file(파일) 또는 logging.path(디렉토리)
    - 기본은 콘솔만 찍힘
  - 로그 레벨 조정: logging.level.패지키 = 로그 레벨

## 로깅 2부: 커스터마이징
https://docs.spring.io/spring-boot/docs/current/reference/html/howto-logging.html

+ logging.level.org.springframework=debug : 스프링 프레임워크 관련 로그 레벨 설정
+ 커스텀 로그 설정 파일 사용하기
  - Logback: logback-spring.xml - 추천
  - Log4J2: log4j2-spring.xml
  - JUL (비추): logging.properties
  - Logback extension
    - 프로파일 ```<springProfile name=”프로파일”>```
    - Environment 프로퍼티 ```<springProperty>```

+ 로거를 Log4j2로 변경하기
  - https://docs.spring.io/spring-boot/docs/current/reference/html/howto-logging.html#howto-configure-log4j-for-logging

## 테스트

+ 시작은 일단 spring-boot-starter-test를 추가(이것만 추가하면 테스트에 필요한것 다 추가됨)
  - test 스콥으로 추가.

+ @SpringBootTest 
  - @RunWith(SpringRunner.class)랑 같이 써야 함. (JUnit 4 기반에서만)
  - 빈 설정 파일은 설정을 안해주나? 알아서 찾습니다. (@SpringBootApplication)
  - webEnvironment
    - MOCK: mock servlet environment. 내장 톰캣 구동 안 함.
      - servlet을 mock up 한다.
      - ``` @Autowired MockMvc mockMvc;```
    - RANDON_PORT, DEFINED_PORT: 내장 톰캣 사용 함.
      - 실제 servlet이 뜬다.
      - 테스트용 restTemplate이나 테스트용 클라이언트를 쓸때 사용한다.
      - ``` @Autowired TestRestTemplate testRestTemplate; ```
    - NONE: 서블릿 환경 제공 안 함.

+ @MockBean
  - ApplicationContext에 들어있는 빈을 Mock으로 만든 객체로 교체 함.
  - 모든 @Test 마다 자동으로 리셋.
  - 예) Service만 테스트하고 싶으면 @MockBean이라는 어노테이션을 붙인다.

+ 슬라이스 테스트
  - 레이어 별로 잘라서 테스트하고 싶을 때
  - @JsonTest
  - @WebMvcTest
    - Web과 관련없는 의존성은 import하지 않는다.
    - 필요에 따라 @MockBean으로 필요한 의존성을 채워주면 된다.
  - @WebFluxTest
  - @DataJpaTest
  - ...

## 테스트 유틸
+ OutputCapture - 제일 유용함
  - 콘솔에 찍힌 모든걸 캡쳐해서 콘솔 메시지를 테스트할 수 있다.
+ TestPropertyValues
+ TestRestTemplate
+ ConfigFileApplicationContextInitializer

## Spring-Boot-Devtools

+ devtools 의존성 추가
  - 의존성을 추가하면 캐시를 off시키는 설정들이 추가된다.
  - 스프링 부트는 base classloader와 restart classloader 두가지를 사용한다.
+ 캐시 설정을 개발 환경에 맞게 변경.
+ 클래스패스에 있는 파일이 변경 될 때마다 자동으로 재시작.
  - 직접 껐다 켜는거 (cold starts)보다 빠른다. 왜?
  - 릴로딩 보다는 느리다. (JRebel 같은건 아님)
  - 리스타트 하고 싶지 않은 리소스는? spring.devtools.restart.exclude
  - 리스타트 기능 끄려면? spring.devtools.restart.enabled = false
+ 라이브 릴로드? 리스타트 했을 때 브라우저 자동 리프레시 하는 기능
  - 브라우저 플러그인 설치해야 함.
  - 라이브 릴로드 서버 끄려면? spring.devtools.liveload.enabled = false
+ 글로벌 설정
  - ~/.spring-boot-devtools.properties
+ 리모트 애플리케이션

## 스프링 웹 MVC 1부: 소개
+ 스프링 웹 MVC
  - https://docs.spring.io/spring/docs/5.0.7.RELEASE/spring-framework-reference/web.html#spring-web
+ 스프링 부트 MVC
  - 자동 설정으로 제공하는 여러 기본 기능 (앞으로 살펴볼 예정)
+ 스프링 MVC 확장
  - @Configuration + WebMvcConfigurer
  - ``` @Configuration
        public void webConfig implements WebMvcConfigurer{}
     ```
+ 스프링 MVC 재정의
  - @Configuration + @EnableWebMvc
